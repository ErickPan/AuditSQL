{% extends 'base.html' %}
{% load staticfiles %}

{% block right_content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header">
                    <div class="mailbox-read-info">
                        <h3 class="box-title"><i class="fa fa-cog"></i> 系统配置编辑</h3>
                    </div>
                </div>
                <div class="box-body">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tab_1" data-toggle="tab">域名配置</a></li>
                            <li><a href="#tab_2" data-toggle="tab">webhook配置</a></li>
                            <li><a href="#tab_3" data-toggle="tab">数据库连接账号配置</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tab_1">
                                <b>当前域名：<i id="domain_name"></i></b>
                                <hr>
                                <form class="form-horizontal" id="domainChangeForm"
                                      action="{% url 'p_get_domain' %}" method="post">
                                    <div class="form-group">
                                        <label class="col-sm-1 control-label" style="text-align: left">新域名</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" name="domain_name"
                                                   placeholder="auditsql.example.com">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-default">提交</button>
                                    {% csrf_token %}
                                </form>
                            </div>
                            <div class="tab-pane" id="tab_2">
                                <b>当前webhook地址：<br><i id="webhook_addr"></i></b>
                                <hr>
                                <form class="form-horizontal" id="webhookChangeForm"
                                      action="{% url 'p_get_webhook' %}" method="post">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label"
                                               style="text-align: left">新webhook地址</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" name="webhook_addr"
                                                   placeholder="https://oapi.dingtalk.com/robot/send?access_token=74fc2...">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-default">提交</button>
                                    {% csrf_token %}
                                </form>
                            </div>
                            <div class="tab-pane" id="tab_3">
                                <div id="toolbar">
                                    <div class="form-inline" role="form">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#modal_new_account"
                                                onclick="new_row()"><i class="fa fa-plus"></i>
                                            新建
                                        </button>
                                        <button type="button" onclick="delete_selected()" class="btn btn-primary"><i
                                                class="fa fa-minus"></i> 删除
                                        </button>
                                    </div>
                                </div>
                                <table id="db-table"></table>
                            </div>
                            <!-- /.tab-pane -->
                        </div>
                        <!-- /.tab-content -->
                    </div>
                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->
        </div>
    </div>

    <div class="modal fade" id="modal_new_account" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <form class="form-horizontal" id="AccountForm" method="post"
                      action="{% url 'p_modify_db_account' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title"><i class="fa fa-pencil"></i> 添加数据库连接账号
                        </h4>
                    </div>

                    <div class="modal-body">
                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">用户</label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <input type="text" maxlength="32" class="form-control"
                                       placeholder="用户" required
                                       name="user">
                            </div>

                            <label class="control-label col-md-2 col-sm-2 col-xs-12">密码</label>
                            <div class="col-md-3 col-sm-3 col-xs-12">
                                <input type="password" maxlength="32" class="form-control"
                                       placeholder="密码" required
                                       name="password">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">主机</label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <input type="text" maxlength="32" class="form-control"
                                       placeholder="目标数据库主机" required
                                       name="host">
                            </div>

                            <label class="control-label col-md-2 col-sm-2 col-xs-12">端口</label>
                            <div class="col-md-3 col-sm-3 col-xs-12">
                                <input type="text" maxlength="32" class="form-control"
                                       placeholder="端口" required
                                       name="port" value="3306">
                            </div>
                        </div>

                        <hr>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">线上/线下</label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <select name="type" id="s_type"
                                        style="width: 100%" class="selectpicker form-control dropup"
                                        required>
                                    <option value="0">线下</option>
                                    <option value="1">线上</option>
                                </select>
                            </div>

                            <label class="control-label col-md-2 col-sm-2 col-xs-12">用途</label>
                            <div class="col-md-3 col-sm-3 col-xs-12">
                                <select name="purpose" id="s_purpose"
                                        style="width: 100%" class="selectpicker form-control dropup"
                                        required>
                                    <option value="0">审核</option>
                                    <option value="1">查询</option>
                                </select>
                            </div>
                        </div>

                        <hr>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12">描述</label>
                            <div class="col-md-9 col-sm-9 col-xs-12">
                                <input type="text" maxlength="32" class="form-control"
                                       placeholder="输入描述"
                                       name="comment" required>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                    {% csrf_token %}
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block link_javascripts %}
    <script>
        var $table = $('#db-table');
        $(function () {
            $table.bootstrapTable({
                method: 'get',
                dataType: 'json',
                url: "{% url 'p_get_db_account' %}",
                cache: false,
                sidePagination: "client",
                showColumns: true,
                clickToSelect: true,
                toolbar: '#toolbar',
                pagination: true,
                search: true,
                showRefresh: true,
                minimumCountColumns: 2,
                pageNumber: 1,                       //初始化加载第一页，默认第一页
                pageSize: 10,                        //每页的记录行数（*）
                pageList: [10, 20, 30],        //可供选择的每页的行数（*）
                uniqueId: "id",                     //每一行的唯一标识，一般为主键列
                classes: 'table table-hover table-no-bordered',
                formatLoadingMessage: function () {
                    return "请稍等，正在加载中...";
                },
                formatNoMatches: function () {
                    return '没有查询到记录...';
                },

                columns: [
                    {
                        checkbox: true
                    },
                    {
                        field: 'id',
                        title: 'ID',
                        visible: false
                    },
                    {
                        field: 'is_enable',
                        title: '启用',
                        formatter: function (value, row) {
                            if (value === 0) {
                                return "<a href='#' onclick=change_db_account_status(" + row.id + ",'1')><i class='fa fa-check-square' style='color:green'></i></a>"
                            }
                            else {
                                return "<a href='#' onclick=change_db_account_status(" + row.id + ",'0')><i class='fa fa-times-circle' style='color:red'></i></a>"
                            }
                        }
                    },
                    {
                        field: 'user',
                        title: '用户',
                        editable: {
                            type: 'text',
                            title: '用户名',
                            validate: function (v) {
                                if (!v) {
                                    return '输入不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'password',
                        title: '密码',
                        editable: {
                            type: 'text',
                            title: '密码',
                            validate: function (v) {
                                if (!v) {
                                    return '输入不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'host',
                        title: '主机',
                        editable: {
                            type: 'text',
                            title: '主机',
                            validate: function (v) {
                                if (!v) {
                                    return '输入不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'port',
                        title: '端口',
                        editable: {
                            type: 'text',
                            title: '端口',
                            validate: function (v) {
                                if (!v) {
                                    return '输入不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'type',
                        title: '线上/线下',
                        editable: {
                            type: 'select',
                            source: [
                                {value: 0, text: '线下'},
                                {value: 1, text: '线上'}
                            ]
                        }
                    },
                    {
                        field: 'purpose',
                        title: '用途',
                        editable: {
                            type: 'select',
                            source: [
                                {value: '0', text: '审核'},
                                {value: '1', text: '查询'}
                            ]
                        }
                    },
                    {
                        field: 'comment',
                        title: "描述",
                        editable: {
                            type: 'text',
                            title: '描述',
                            validate: function (v) {
                                if (!v) {
                                    return '输入不能为空';
                                }
                            }
                        }
                    }
                ],
                // 编辑保存，上面的editable统一调用此方法
                onEditableSave: function (field, row, oldValue, $el) {
                    var csrftoken = $.cookie('csrftoken');
                    row.csrfmiddlewaretoken = csrftoken;
                    row.action = 'modify_value';

                    $.ajax({
                        type: "post",
                        url: "{% url 'p_modify_db_account' %}",
                        data: row,
                        dataType: 'JSON',
                        success: function (result) {
                            displayPNotify(result.status, result.msg)
                        },
                        error: function (jqXHR) {
                            if (jqXHR.status === 403) {
                                displayPNotify(jqXHR.status)
                            }
                        }
                    });
                }
            })
        });

        // 修改状态
        function change_db_account_status(id, status) {
            var csrftoken = $.cookie('csrftoken');
            $.ajax({
                url: '{% url 'p_modify_db_account' %}',
                type: 'POST',
                dataType: 'json',
                data: {'action': 'modify_status', 'id': id, 'status': status, 'csrfmiddlewaretoken': csrftoken},
                timeout: 5000,
                cache: false,
                success: function (result) {
                    displayPNotify(result.status, result.msg);
                    $table.bootstrapTable('refresh', {silent: true});
                },
                error: function (jqXHR) {
                    if (jqXHR.status === 403) {
                        displayPNotify(jqXHR.status)
                    }
                }
            })
        }


        /**
         * 获取域名
         */
        function get_domain_name() {
            $('#domain_name').empty();
            $.ajax({
                url: '{% url 'p_get_domain' %}',
                type: 'GET',
                dataType: 'json',
                timeout: 5000,
                cache: false,
                success: function (result) {
                    $('#domain_name').append(result.data)
                }
            })
        }

        get_domain_name();

        function validate_domain_name(formData, jqForm, options) {
            var form = jqForm[0];
            if (!form.domain_name.value) {
                displayPNotify(2, '输入不能为空.');
                return false;
            }
        }

        $('#domainChangeForm').submit(function () {
            var csrftoken = $.cookie('csrftoken');
            $(this).ajaxSubmit({
                dataType: 'json',
                resetForm: true,
                beforeSubmit: validate_domain_name,
                data: {'csrfmiddlewaretoken': csrftoken},
                success: function (result) {
                    displayPNotify(result.status, result.msg);
                    get_domain_name()
                }
            });
            return false //阻止表单自动提交数据
        });


        /**
         * 获取webhook
         */
        function get_webhook() {
            $('#webhook_addr').empty();
            $.ajax({
                url: '{% url 'p_get_webhook' %}',
                type: 'GET',
                dataType: 'json',
                timeout: 5000,
                cache: false,
                success: function (result) {
                    $('#webhook_addr').append(result.data)
                }
            })
        }

        get_webhook();

        function validate_webhook(formData, jqForm, options) {
            var form = jqForm[0];
            if (!form.webhook_addr.value) {
                displayPNotify(2, '输入不能为空.');
                return false;
            }
        }

        $('#webhookChangeForm').submit(function () {
            var csrftoken = $.cookie('csrftoken');
            $(this).ajaxSubmit({
                dataType: 'json',
                resetForm: true,
                beforeSubmit: validate_webhook,
                data: {'csrfmiddlewaretoken': csrftoken},
                success: function (result) {
                    displayPNotify(result.status, result.msg);
                    get_webhook()
                }
            });
            return false //阻止表单自动提交数据
        });

        // 新建任务
        $('#AccountForm').submit(function () {
            $(this).ajaxSubmit({
                dataType: 'json',
                resetForm: true,
                data: {'action': 'new_row'},
                success: function (result) {
                    if (result.status === 0) {
                        displayPNotify(result.status, result.msg);
                        $('#modal_new_account').modal('hide');
                        $table.bootstrapTable('refresh', {silent: true});
                    } else {
                        displayPNotify(result.status, result.msg);
                    }
                },
                error: function (jqXHR) {
                    if (jqXHR.status === 403) {
                        $('#modal_new_account').modal('hide');
                        displayPNotify(jqXHR.status)
                    }
                }
            });
            return false
        });


        // 删除选择的数据
        function delete_selected() {
            var selectedContent = $table.bootstrapTable('getAllSelections');
            var id = [];
            selectedContent.forEach(function (val) {
                id.push(val['id'])
            });
            if (id.length === 0) {
                displayPNotify(2, '请至少勾选一行数据');
                return false;
            } else {
                var csrftoken = $.cookie('csrftoken');
                $.ajax({
                    url: '{% url 'p_modify_db_account' %}',
                    type: 'POST',
                    dataType: 'json',
                    timeout: 1000,
                    data: {
                        'action': 'delete_row',
                        'id': id.toString(),
                        'csrfmiddlewaretoken': csrftoken
                    },
                    cache: false,
                    success: function (result) {
                        displayPNotify(result.status, result.msg);
                        $table.bootstrapTable('refresh', {silent: true});
                    },
                    error: function (jqXHR) {
                        if (jqXHR.status === 403) {
                            displayPNotify(jqXHR.status)
                        }
                    }
                })
            }
        }

    </script>
{% endblock %}